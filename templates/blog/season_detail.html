{% extends "base.html" %} {% block content %}

{% load crispy_forms_tags %}

<!-- Page content-->
<div class="container mt-5">
    <div class="row">
        <div class="col-lg-8">
            <!-- Post content-->
            <article>
                <!-- Post header-->
                <header class="mb-4">
                    <!-- Post title-->
                    <h1 class="fw-bolder mb-1">Welcome to {{ season.title }}</h1>
                    <!-- Post meta content-->
                    <div class="text-muted fst-italic mb-2">Posted on {{ season.created_on }}</div>
                    <!-- Post categories-->
                    <a class="badge bg-secondary text-decoration-none link-light" href="#!">Web Design</a>
                    <a class="badge bg-secondary text-decoration-none link-light" href="#!">Freebies</a>
                </header>
                <!-- Preview image figure-->
                <figure class="mb-4">
                    <a href="{% url 'homepage' %}">
                        <img class="img-fluid rounded" src="https://dummyimage.com/900x400/ced4da/6c757d.jpg" alt="...">
                    </a>
                </figure>
                <!-- Post content-->
                <section class="mb-5">
                    <p class="fs-5 mb-4">Science is an enterprise that should be cherished as an activity of the
                        free human mind. Because it transforms who we are, how we live, and it gives us an
                        understanding of our place in the universe.</p>
                    <p class="fs-5 mb-4">The universe is large and old, and the ingredients for life as we know it
                        are everywhere, so there's no reason to think that Earth would be unique in that regard.
                        Whether of not the life became intelligent is a different question, and we'll see if we find
                        that.</p>
                    <p class="fs-5 mb-4">If you get asteroids about a kilometer in size, those are large enough and
                        carry enough energy into our system to disrupt transportation, communication, the food
                        chains, and that can be a really bad day on Earth.</p>
                    <h2 class="fw-bolder mb-4 mt-5">I have odd cosmic thoughts every day</h2>
                    <p class="fs-5 mb-4">For me, the most fascinating interface is Twitter. I have odd cosmic
                        thoughts every day and I realized I could hold them to myself or share them with people who
                        might be interested.</p>
                    <p class="fs-5 mb-4">Venus has a runaway greenhouse effect. I kind of want to know what happened
                        there because we're twirling knobs here on Earth without knowing the consequences of it.
                        Mars once had running water. It's bone dry today. Something bad happened there as well.</p>
                </section>
            </article>
            <!-- Comments section-->
            <section class="mb-5">
                <div class="card bg-light">
                    <div class="card-body">

                        <!-- Comments with nested replies -->
                        {% for comment in season.comments.all %}
                        <div class="d-flex mb-4">

                            <!-- User's profile image -->
                            <div class="flex-shrink-0">
                                <img class="rounded-circle" src="https://dummyimage.com/50x50/ced4da/6c757d.jpg"
                                    alt="...">
                            </div>

                            <!-- editCommentDiv - initially hidden - replaces the comment itself (below) when active -->
                            <div class="flex-grow-1 ms-3 d-none" id="edit-comment{{ comment.id }}">
                                <div class="fw-bold">{{ comment.user }}</div>
                                <form method="post" action="{% url 'update_comment' slug=season.slug pk=comment.id %}">
                                    {% csrf_token %}
                                    <textarea name="body" rows="3" style="width: 100%;">{{ comment.body }}</textarea>
                                    <button type="submit" class="btn btn-outline-success">Update</button>
                                </form>
                            </div>

                            <!-- commentDiv -->
                            <div class="flex-grow-1 ms-3" id="comment{{ comment.id }}">
                                <div class="fw-bold">{{ comment.user }}</div>
                                {{ comment.body }}

                                {% if user == comment.user %}
                                <!-- Delete button - triggers confirmationModal -->
                                <div class="row">
                                    <div class="col-9"></div>
                                    <div class="col-1">
                                        <a class="edit-comment" data-comment-id="{{ comment.id }}">
                                            <i class="fa-solid fa-pen"></i></a>
                                    </div>
                                    <div class="col-1">
                                        <a data-comment-id="{{ comment.id }}" data-bs-toggle="modal"
                                            data-bs-target="#modal{{ comment.id }}">
                                            <i class="fa-solid fa-trash" style="color: #ff0000;"></i></a>
                                    </div>
                                </div>

                                <!-- Edit button - toggles d-none between 'commentDiv' and 'editCommentDiv' -->
                                {% endif %}

                                <!-- Reply form - inline JavaScript injection when clicked -->
                                {% if user.is_authenticated %}
                                <div>
                                    <a class="reply-link" data-comment-id="{{ comment.id }}"
                                        data-comment-user="{{ comment.user }}">reply</a>
                                </div>
                                {% endif %}

                                <!-- Replies -->
                                {% for reply in comment.replies.all %}
                                <div class="d-flex mt-3">
                                    <div class="flex-shrink-0">
                                        <img class="rounded-circle" src="https://dummyimage.com/50x50/ced4da/6c757d.jpg"
                                            alt="...">
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <div class="fw-bold">{{ reply.user }}</div>
                                        {{ reply.body }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Delete confirmationModal -->
                        <form method="post" action="{% url 'delete_comment' slug=season.slug pk=comment.id %}">
                            {% csrf_token %}
                            <div class="modal fade" id="modal{{ comment.id }}" data-bs-backdrop="static"
                                data-bs-keyboard="false" tabindex="-1" aria-labelledby="confirmationModal"
                                aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h1 class="modal-title fs-5" id="confirmationModal">Delete
                                                comment?
                                            </h1>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            You cannot undo this action.
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary"
                                                data-bs-dismiss="modal">Close</button>
                                            <button type="submit" class="btn btn-danger">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                        {% endfor %}

                        <!-- Sticky comment form-->
                        {% if user.is_authenticated %}
                        <div class="sticky-bottom d-flex blurry-overlay" id="comment-form">
                            <div class="flex-shrink-0 mt-2">
                                <img class="rounded-circle" src="https://dummyimage.com/50x50/ced4da/6c757d.jpg"
                                    alt="...">
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <form method="post" action="{% url 'season_comment' slug=season.slug %}" class="mt-3">
                                    {% csrf_token %}
                                    <div class="row d-flex g-0">
                                        <div class="col">
                                            {{ comment_form | crispy }}
                                        </div>
                                        <div class="col-auto">
                                            <button type="submit" class="btn btn-outline-success">Post</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Sticky reply form-->
                        <div class="sticky-bottom blurry-overlay d-none" id="reply-form">
                            <!-- Inline JavaScript injection -->
                        </div>

                    </div>
                </div>
            </section>
        </div>
        <!-- Side widgets-->
        <div class="col-lg-4">
            <!-- Search widget-->
            <div class="card mb-4">
                <div class="card-header">Search</div>
                <div class="card-body">
                    <div class="input-group">
                        <input class="form-control" type="text" placeholder="Enter search term..."
                            aria-label="Enter search term..." aria-describedby="button-search">
                        <button class="btn btn-primary" id="button-search" type="button">Go!</button>
                    </div>
                </div>
            </div>
            <!-- Categories widget-->
            <div class="card mb-4">
                <div class="card-header">Categories</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <ul class="list-unstyled mb-0">
                                <li><a href="#!">Web Design</a></li>
                                <li><a href="#!">HTML</a></li>
                                <li><a href="#!">Freebies</a></li>
                            </ul>
                        </div>
                        <div class="col-sm-6">
                            <ul class="list-unstyled mb-0">
                                <li><a href="#!">JavaScript</a></li>
                                <li><a href="#!">CSS</a></li>
                                <li><a href="#!">Tutorials</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Side widget-->
            <div class="card mb-4">
                <div class="card-header">Side Widget</div>
                <div class="card-body">You can put anything you want inside of these side widgets. They are easy to
                    use, and feature the Bootstrap 5 card component!</div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block script %}
<script>
    document.addEventListener("DOMContentLoaded", function (e) {

        // Event listeners for 'reply'
        const replyLinks = document.querySelectorAll(".reply-link");

        replyLinks.forEach(function (link) {
            link.addEventListener("click", function (e) {

                // Season slug from current URL in window
                const pathArray = window.location.pathname.split("/");
                const seasonSlug = pathArray[pathArray.length - 2];

                // comment.id and comment.user from data- attribute
                let commentId = link.getAttribute("data-comment-id");
                let commentUser = link.getAttribute("data-comment-user")

                // Set URL accordingly
                let url = `/season/${seasonSlug}/${commentId}/reply`;

                // Hide commentForm and display replyForm instead
                const replyFormDiv = document.getElementById("reply-form");
                const commentFormDiv = document.getElementById("comment-form");
                commentFormDiv.classList.add("d-none");
                replyFormDiv.classList.remove("d-none");

                // Custom innerHTML for replyForm
                replyFormDiv.innerHTML = `
                <div class="row">
                    <div class="col">
                        replying to ${commentUser}
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-sm btn-close" id="close-reply-form" aria-label="Close"></button>
                    </div>
                </div>
                <div class="d-flex">
                    <div class="flex-shrink-0 mt-2">
                        <img class="rounded-circle" src="https://dummyimage.com/50x50/ced4da/6c757d.jpg" alt="...">
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <form method="post" action="${url}" class="mt-3">
                            {% csrf_token %}
                            <div class="row d-flex g-0">
                                <div class="col">
                                    {{ reply_form | crispy }}
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-outline-success">Reply</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                `;

                // Hide replyForm and display commentForm instead
                const closeReplyFormButton = document.getElementById("close-reply-form");
                closeReplyFormButton.addEventListener("click", function (e) {
                    replyFormDiv.classList.add("d-none");
                    commentFormDiv.classList.remove("d-none");
                });
            });
        });

        // Event listeners for editing comments
        const editCommentButtons = document.querySelectorAll(".edit-comment")

        editCommentButtons.forEach(function (button) {
            button.addEventListener("click", function (e) {

                // comment.id from data- attribute
                let commentId = button.getAttribute("data-comment-id");
                let commentDiv = document.getElementById(`comment${commentId}`)
                let editCommentDiv = document.getElementById(`edit-comment${commentId}`);

                // Hide the comment itself and replace with the update form
                commentDiv.classList.add("d-none");
                editCommentDiv.classList.remove("d-none");
            });
        });
    });
</script>
{% endblock script %}